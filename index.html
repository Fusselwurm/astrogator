<html>
<head>
	<title>astrogat0r</title>
	<script type="text/javascript"
		src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type="text/javascript" src="./vector.js"></script>
	<script type="text/javascript" src="./lib.js"></script>
	<script type="text/javascript" src="./test.js"></script>
	<style type="text/css">
		canvas {
			border: 5px solid black;
		}

		input[id=inpScale] {
			width: 400px;
		}
	</style>
</head>
<body>
<h1>buttons</h1>
<button id="btnClear">clear</button>
<button id="btnStop">stop</button>
<button id="btnGo">go</button>
<label for="inpScale">scale (e10)</label><input id="inpScale" type="range"
						min="-22" max="22"
						step="0.5"
						value="0"
    /><span
    id="inpScaleShow"></span>
<input id="inpAttachedTo"  type="text" disabled="disabled" value="---" />
<h2>canvas</h2>

<canvas id="space" width="500" height="500"></canvas>

<script type="text/javascript">

	var
		scale = 1e-10,
		translation = new Vector([0, 0, 0]), // in meters!
	    	attachedTo = null,
		cnvs = document.getElementById('space'),
		ctx = cnvs.getContext('2d');

	ctx.fillStyle = "rgba(255, 255, 0, 1)";

	function canvasPointToSpacePoint(v) {
		return new Vector(v.
		    map(function (v) {
			return (v - 250) / scale;
		})).add(translation.invert());
	}

	function spacePointToCanvasPoint(v) {
		return new Vector(v.
		    add(translation.invert()).
		    map(function (v) {
			    return (v * scale) + 250;
		    }));
	}

	move.onChange((function () {
		//var cnt = {};
		return function (body) {

			if (attachedTo) {
				translation = attachedTo.position;
			}

			var
			    posTranslated = spacePointToCanvasPoint(body.position),
			    getColor = function (b) {
				    return [
					    b.mass % 255,
					    (b.name.charCodeAt(0) + b.name.charCodeAt(1)) % 255,
					    b.vector.norm() / 255
				    ].map(function (n) {
					    return Math.floor(n);
				    });
			    },
			    c = getColor(body);

			ctx.fillStyle = "rgba(" + c.join(',') + ", 1)";

			ctx.fillRect(posTranslated[0], posTranslated[1], 2, 2);
		};
	}()));

</script>

<script type="text/javascript">

	var
	    	tick = 0,
	    	s = ASTROGATOR.systems.sol;

	s.forEach(function (body, i) {
		var
			reference = s.getByName(body.orbital_reference),
			dist = (body.periapsis + body.apoapsis) / 2,
			position,
			vector;

		if (reference) {
			// ok this is stupid, should distribute planets smarter
			body.position = reference.position.add(new Vector(i % 2 ? [-dist, 0, 0] : [dist, 0, 0]));
			body.vector = reference.vector.add(new Vector(i % 2 ? [0, body.average_orbital_velocity, 0]: [0, -body.average_orbital_velocity, 0]));
		} else {
			// which is the case for Sol, b/c it is not assumed to be in orbit around anything here
			body.position = new Vector([0, 0, 0]);
			body.vector = new Vector([0, 0, 0]);
		}


	});

	$(document).ready(function () {
		$('#btnGo').click(function () {
			tick = setInterval(function () {
				move(s, 1000);
			}, 0);
		});
		$('#btnStop').click(function () {
			clearInterval(tick);
		});
		$('#btnClear').click(function () {
			ctx.clearRect(0, 0, 500, 500);
		});


		$('#inpScale').change(function () {
			scale = Math.pow(10, this.value);
			ctx.clearRect(0, 0, 500, 500);
			$('#inpScaleShow').text(scale);

		}).attr('value', Math.round(Math.log(scale) / Math.LN10));

		$('#space').mousedown(function (event) {
				var from = [event.pageX, event.pageY];
				$(this).one({
					mouseup: function (event) {
						var diff = [
							event.pageX - from[0],
							event.pageY - from[1],
						    	0
						];

						translation = translation.add((new Vector (diff)).multiply(1 / scale));
					}
				});
			}).dblclick(function (event) {
			    // attach to object
			    var
				minDiff = Infinity,
				cnvsoffset = $(this).offset(),
				point = canvasPointToSpacePoint(new Vector([event.offsetX, event.offsetY, 0]));
			    attachedTo = s.reduce(function (prev, body) {
				    var tmp = body.position.diff(point).norm();
				    if (tmp < minDiff) {
					    minDiff = tmp;
					    return body;
				    }
				    return prev;
			    }, null);
			    $('#inpAttachedTo').val(attachedTo.name || '???');
			});



		setInterval(function () {
			ctx.fillStyle = "rgba(255, 255, 255, 0.05)";
			ctx.fillRect(0, 0, 500, 500);
		}, 1000);
	});
</script>
</body>
</html>
